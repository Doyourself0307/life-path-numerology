<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå‘½æ•°å­—å¯†ç  Â· å…«å­—äº”è¡Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-primary: #0a0a12;
            --bg-secondary: #12121f;
            --bg-card: #1a1a2e;
            --accent-gold: #d4af37;
            --accent-gold-light: #f4e4a6;
            --accent-purple: #6b4c9a;
            --accent-blue: #4a6fa5;
            --accent-red: #c45c5c;
            --accent-green: #4a9a6b;
            --accent-earth: #a67c52;
            --text-primary: #e8e6e3;
            --text-secondary: #a0a0a0;
            --border-glow: rgba(212, 175, 55, 0.3);
            /* äº”è¡Œé¢œè‰² */
            --wood: #2d8f4e;
            --fire: #dc4f4f;
            --earth: #c9a227;
            --metal: #e8e8e8;
            --water: #3a7bd5;
        }

        .dark {
            --bg-primary: #0a0a12;
            --bg-secondary: #12121f;
            --bg-card: #1a1a2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(107, 76, 154, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(74, 111, 165, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
            z-index: 0;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--accent-gold-light);
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 1s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-light), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.3rem;
            color: var(--text-secondary);
            letter-spacing: 6px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            letter-spacing: 2px;
            margin-top: 10px;
        }

        .sacred-circle {
            width: 100px;
            height: 100px;
            margin: 0 auto 25px;
            position: relative;
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .sacred-circle::before,
        .sacred-circle::after {
            content: '';
            position: absolute;
            border: 1px solid var(--accent-gold);
            border-radius: 50%;
            opacity: 0.5;
        }

        .sacred-circle::before { width: 100%; height: 100%; top: 0; left: 0; }
        .sacred-circle::after { width: 70%; height: 70%; top: 15%; left: 15%; }

        .sacred-inner {
            position: absolute;
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
            border: 1px solid var(--accent-gold);
            border-radius: 50%;
            opacity: 0.5;
        }

        /* Bagua decoration */
        .bagua-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            opacity: 0.6;
        }

        /* Input Card */
        .input-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px 30px;
            border: 1px solid var(--border-glow);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(212, 175, 55, 0.1);
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 500px) {
            .input-row { grid-template-columns: 1fr; }
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .input-group label .hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: none;
            letter-spacing: 0;
            margin-left: 5px;
        }

        .date-input, .time-select {
            width: 100%;
            padding: 16px 18px;
            font-size: 16px;
            font-family: 'Noto Serif SC', serif;
            background: var(--bg-secondary);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .date-input:focus, .time-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        /* æ€§åˆ«é€‰æ‹©æ ·å¼ */
        .gender-group {
            margin-bottom: 25px;
        }

        .gender-options {
            display: flex;
            gap: 15px;
        }

        .gender-option {
            flex: 1;
            cursor: pointer;
        }

        .gender-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .gender-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 18px 20px;
            background: var(--bg-secondary);
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
            gap: 8px;
        }

        .gender-icon {
            font-size: 1.6rem;
            line-height: 1;
        }

        .gender-btn span:last-child {
            font-size: 0.95rem;
            letter-spacing: 2px;
        }

        .gender-option input[type="radio"]:checked + .gender-btn {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
        }

        .gender-option:hover .gender-btn {
            border-color: rgba(212, 175, 55, 0.4);
        }

        .gender-option input[value="male"]:checked + .gender-btn {
            border-color: var(--accent-blue);
            background: rgba(74, 111, 165, 0.15);
            box-shadow: 0 0 20px rgba(74, 111, 165, 0.2);
        }

        .gender-option input[value="male"]:checked + .gender-btn .gender-icon {
            color: #7ea6d9;
        }

        .gender-option input[value="female"]:checked + .gender-btn {
            border-color: #e07a9a;
            background: rgba(224, 122, 154, 0.15);
            box-shadow: 0 0 20px rgba(224, 122, 154, 0.2);
        }

        .gender-option input[value="female"]:checked + .gender-btn .gender-icon {
            color: #e07a9a;
        }

        /* æ€§åˆ«ç»“æœæ ‡è¯† */
        .gender-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .gender-badge.male {
            background: rgba(74, 111, 165, 0.2);
            border: 1px solid rgba(74, 111, 165, 0.4);
            color: #7ea6d9;
        }

        .gender-badge.female {
            background: rgba(224, 122, 154, 0.2);
            border: 1px solid rgba(224, 122, 154, 0.4);
            color: #e07a9a;
        }

        .gender-badge .badge-icon {
            font-size: 1.1rem;
        }

        .calculate-btn {
            width: 100%;
            padding: 18px 30px;
            font-size: 1.1rem;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--accent-gold), #c9a227);
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }

        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Result Section */
        .result-section {
            margin-top: 40px;
            display: none;
        }

        .result-section.show {
            display: block;
            animation: fadeInUp 0.8s ease-out;
        }

        /* Life Number Display */
        .life-number-display {
            text-align: center;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px 30px;
            border: 1px solid var(--border-glow);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .life-number-display::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.1) 0%, transparent 70%);
            transform: translate(-50%, -50%);
        }

        /* ä¸»æ€§æ ¼ç‰¹è´¨åŒº */
        .main-traits-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(212, 175, 55, 0.15);
            text-align: left;
            position: relative;
            z-index: 1;
        }

        .main-traits-title {
            font-size: 0.9rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .main-traits-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 500px) {
            .main-traits-grid { grid-template-columns: 1fr; }
        }

        .main-trait-box {
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .main-trait-box.positive {
            background: rgba(74, 154, 107, 0.12);
            border-left: 3px solid var(--accent-green);
        }

        .main-trait-box.negative {
            background: rgba(196, 92, 92, 0.12);
            border-left: 3px solid var(--accent-red);
        }

        .main-trait-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .main-trait-box.positive .main-trait-label { color: #7dd3a1; }
        .main-trait-box.negative .main-trait-label { color: #e8a5a5; }

        .main-trait-content {
            color: var(--text-secondary);
        }

        .number-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .life-number {
            font-family: 'Cinzel', serif;
            font-size: clamp(4rem, 12vw, 6rem);
            font-weight: 700;
            background: linear-gradient(180deg, var(--accent-gold-light), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        .calculation-process {
            margin-top: 20px;
            padding: 12px 18px;
            background: var(--bg-secondary);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* å…«å­—äº”è¡Œå¡ç‰‡ */
        .bazi-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px 30px;
            border: 1px solid var(--border-glow);
            margin-bottom: 25px;
        }

        .card-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.4rem;
            color: var(--accent-gold);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title::before {
            content: 'â˜¯';
            font-size: 1.2rem;
        }

        /* å…«å­—æ˜¾ç¤º */
        .bazi-pillars {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .bazi-pillar {
            text-align: center;
            padding: 20px 10px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.15);
        }

        .pillar-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .pillar-chars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tiangan {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.8rem;
            line-height: 1;
        }

        .dizhi {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.8rem;
            line-height: 1;
        }

        .element-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .element-wood { background: rgba(45, 143, 78, 0.2); color: var(--wood); }
        .element-fire { background: rgba(220, 79, 79, 0.2); color: var(--fire); }
        .element-earth { background: rgba(201, 162, 39, 0.2); color: var(--earth); }
        .element-metal { background: rgba(200, 200, 200, 0.2); color: var(--metal); }
        .element-water { background: rgba(58, 123, 213, 0.2); color: var(--water); }

        /* äº”è¡Œåˆ†æ */
        .wuxing-analysis {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(212, 175, 55, 0.15);
        }

        .wuxing-title {
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wuxing-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wuxing-bar {
            display: grid;
            grid-template-columns: 50px 1fr 35px;
            align-items: center;
            gap: 12px;
        }

        .wuxing-label {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wuxing-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .wuxing-track {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .wuxing-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-out;
        }

        .wuxing-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: right;
        }

        /* æµå¹´è¿åŠ¿ */
        .fortune-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px 30px;
            border: 1px solid var(--border-glow);
            margin-bottom: 25px;
        }

        .fortune-timeline {
            position: relative;
            padding-left: 30px;
        }

        .fortune-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 10px;
            bottom: 10px;
            width: 2px;
            background: linear-gradient(180deg, var(--accent-purple), var(--accent-gold), var(--accent-blue));
        }

        .fortune-year {
            position: relative;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border-left: 3px solid transparent;
        }

        .fortune-year.past { border-left-color: var(--accent-purple); }
        .fortune-year.current { border-left-color: var(--accent-gold); background: rgba(212, 175, 55, 0.08); }
        .fortune-year.future { border-left-color: var(--accent-blue); }

        .fortune-year::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 25px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }

        .fortune-year.past::before { border-color: var(--accent-purple); background: var(--bg-primary); }
        .fortune-year.current::before { border-color: var(--accent-gold); background: var(--accent-gold); }
        .fortune-year.future::before { border-color: var(--accent-blue); background: var(--bg-primary); }

        .year-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .year-label {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .year-element {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .year-status {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .year-status.past { background: rgba(107, 76, 154, 0.2); color: #b49ae0; }
        .year-status.current { background: rgba(212, 175, 55, 0.2); color: var(--accent-gold); }
        .year-status.future { background: rgba(74, 111, 165, 0.2); color: #7ea6d9; }

        .year-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .fortune-aspect {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255,255,255,0.1);
        }

        .aspect-label {
            font-size: 0.8rem;
            color: var(--accent-gold-light);
            margin-bottom: 5px;
        }

        /* Personality Card */
        .personality-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px 30px;
            border: 1px solid var(--border-glow);
            margin-bottom: 25px;
        }

        .personality-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .keyword {
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(107, 76, 154, 0.3), rgba(74, 111, 165, 0.3));
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-gold-light);
        }

        .personality-desc {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .challenges-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(212, 175, 55, 0.15);
        }

        .challenges-title {
            font-size: 1rem;
            color: #c97b7b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .challenges-title::before { content: 'âš¡'; font-size: 0.9rem; }

        .challenge-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .challenge-tag {
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(201, 123, 123, 0.2), rgba(180, 100, 100, 0.15));
            border: 1px solid rgba(201, 123, 123, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #e8a5a5;
        }

        .challenges-desc {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* ç”Ÿå‘½æ•°å­—å¯†ç æ‰©å±•å¡ç‰‡ */
        .numerology-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px 30px;
            border: 1px solid var(--border-glow);
            margin-bottom: 25px;
        }

        /* æ ¸å¿ƒç +ä¹å®«æ ¼çš„wrapperï¼ˆ2åˆ—3è¡Œç½‘æ ¼ï¼‰ */
        .codes-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 600px) {
            .codes-wrapper { grid-template-columns: 1fr; }
        }

        /* code-gridä½¿ç”¨display:contentsè®©å­å…ƒç´ ç›´æ¥å‚ä¸çˆ¶grid */
        .code-grid {
            display: contents;
        }

        .code-item {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(212, 175, 55, 0.15);
            transition: all 0.3s ease;
        }

        .code-item:hover {
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .code-name {
            font-size: 0.9rem;
            color: var(--accent-gold);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-number {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(180deg, var(--accent-gold-light), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .code-traits {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trait-section {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .trait-positive {
            background: rgba(74, 154, 107, 0.15);
            border-left: 3px solid var(--accent-green);
        }

        .trait-positive .trait-label {
            color: #7dd3a1;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }

        .trait-positive .trait-content {
            color: #a8e6c3;
        }

        .trait-negative {
            background: rgba(196, 92, 92, 0.15);
            border-left: 3px solid var(--accent-red);
        }

        .trait-negative .trait-label {
            color: #e8a5a5;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }

        .trait-negative .trait-content {
            color: #f0bfbf;
        }

        /* ä¹å®«æ ¼ */
        .grid-title {
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            width: 140px;
            margin: 0 auto;
        }

        .grid-cell {
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s ease;
        }

        .grid-cell.active {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .grid-cell.active::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent-gold);
            border-radius: 50%;
            bottom: 3px;
            right: 3px;
        }

        /* å¯¼å‡ºç”¨çš„å®é™…åœ†ç‚¹å…ƒç´ ï¼ˆç”¨äºSVGå¯¼å‡ºæ—¶æ›¿ä»£ä¼ªå…ƒç´ ï¼‰ */
        .grid-cell .active-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent-gold);
            border-radius: 50%;
            bottom: 3px;
            right: 3px;
        }

        .grid-cell .count {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.6rem;
            color: var(--accent-gold-light);
            font-family: 'Noto Serif SC', serif;
        }

        .grid-legend-inline {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
            line-height: 1.5;
        }

        /* ä¹å®«æ ¼æ ¼å­æ ·å¼ */
        .nine-grid-cell {
            display: flex;
            flex-direction: column;
        }

        .nine-grid-cell .code-header {
            margin-bottom: 15px;
        }

        .nine-grid-cell .code-name {
            font-size: 0.95rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .nine-grid-cell .nine-grid {
            margin: 0 auto 10px;
        }

        .nine-grid-cell .grid-legend-inline {
            margin-top: auto;
        }

        /* è”åˆç åŒºåŸŸ */
        .union-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(212, 175, 55, 0.15);
        }

        .union-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        /* è”åˆç åˆ—è¡¨ - 3*4ç½‘æ ¼å¸ƒå±€ */
        .union-codes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        @media (max-width: 900px) {
            .union-codes { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 500px) {
            .union-codes { grid-template-columns: 1fr; }
        }

        .union-code-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px 14px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .union-code-item.active {
            border-left-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.08);
        }

        .union-code-item.inactive {
            opacity: 0.45;
        }

        .union-code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .union-code-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .union-code-numbers {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .union-code-status {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 8px;
            margin-left: 5px;
        }

        .union-code-status.has {
            background: rgba(74, 154, 107, 0.2);
            color: #7dd3a1;
        }

        .union-code-status.missing {
            background: rgba(150, 150, 150, 0.2);
            color: #999;
        }

        .union-code-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 6px;
        }

        .union-code-item.active .union-code-desc {
            color: var(--accent-gold-light);
        }

        /* æ½œæ„è¯†ç ç¼ºå¤±æ•°å­— */
        .missing-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .missing-number {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(107, 76, 154, 0.2);
            border: 2px dashed var(--accent-purple);
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--accent-purple);
        }

        .no-missing {
            color: var(--accent-green);
            font-size: 0.9rem;
            padding: 10px;
            background: rgba(74, 154, 107, 0.1);
            border-radius: 10px;
        }

        /* å»ºè®®å¡ç‰‡ */
        .advice-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px 30px;
            border: 1px solid var(--border-glow);
            margin-bottom: 25px;
        }

        .advice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .advice-grid { grid-template-columns: 1fr; }
        }

        .advice-section {
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .advice-section-title {
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advice-section-title.work::before { content: 'ğŸ’¼'; }
        .advice-section-title.life::before { content: 'ğŸŒ¿'; }

        .advice-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        /* AI Analysis */
        .ai-analysis {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px 30px;
            border: 1px solid var(--border-glow);
        }

        .ai-content {
            color: var(--text-secondary);
            line-height: 1.9;
            font-size: 0.95rem;
            min-height: 200px; /* é˜²æ­¢å†…å®¹åˆšå¼€å§‹ç”Ÿæˆæ—¶é«˜åº¦å¡Œé™· */
        }

        .ai-content h1, .ai-content h2, .ai-content h3 {
            color: var(--accent-gold);
            margin: 25px 0 15px;
            font-family: 'Noto Serif SC', serif;
        }

        .ai-content h1:first-child, .ai-content h2:first-child, .ai-content h3:first-child { margin-top: 0; }
        .ai-content p { margin-bottom: 15px; }
        .ai-content ul, .ai-content ol { margin: 15px 0; padding-left: 25px; }
        .ai-content li { margin-bottom: 8px; }
        .ai-content strong { color: var(--text-primary); }
        .ai-content em { color: var(--accent-gold-light); }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-secondary);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .error-text {
            color: #e57373;
            padding: 15px;
            background: rgba(229, 115, 115, 0.1);
            border-radius: 10px;
            text-align: center;
        }

        /* åå­—è¾“å…¥æ¡† */
        .name-input {
            width: 100%;
            padding: 16px 18px;
            font-size: 16px;
            font-family: 'Noto Serif SC', serif;
            background: var(--bg-secondary);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 2px;
        }

        .name-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .name-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* ç»“æœåŒºæ˜¾ç¤ºåå­— */
        .result-name {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.6rem;
            color: var(--accent-gold-light);
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        /* å¯„è¯­åŒºåŸŸ */
        .blessing-section {
            margin-top: 40px;
            padding: 30px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-glow);
            text-align: center;
        }

        .blessing-divider {
            width: 60%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.4), transparent);
            margin: 0 auto 20px;
        }

        .blessing-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.2rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            letter-spacing: 3px;
        }

        .blessing-content {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.8;
            font-style: italic;
        }

        /* å¯¼å‡ºæŒ‰é’®åŒºåŸŸ */
        .export-section {
            margin-top: 25px;
            padding: 30px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-glow);
        }

        .export-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.3rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .export-title::before {
            content: 'ğŸ“¤';
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .export-btn {
            padding: 16px 24px;
            font-size: 1rem;
            font-family: 'Noto Serif SC', serif;
            font-weight: 600;
            letter-spacing: 2px;
            border: 2px solid;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .export-btn.image {
            background: linear-gradient(135deg, rgba(74, 111, 165, 0.2), rgba(107, 76, 154, 0.2));
            border-color: var(--accent-blue);
            color: #7ea6d9;
        }

        .export-btn.image:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(74, 111, 165, 0.4), rgba(107, 76, 154, 0.4));
            box-shadow: 0 5px 25px rgba(74, 111, 165, 0.3);
            transform: translateY(-2px);
        }

        .export-btn.pdf {
            background: linear-gradient(135deg, rgba(196, 92, 92, 0.2), rgba(212, 175, 55, 0.2));
            border-color: var(--accent-red);
            color: #e8a5a5;
        }

        .export-btn.pdf:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(196, 92, 92, 0.4), rgba(212, 175, 55, 0.4));
            box-shadow: 0 5px 25px rgba(196, 92, 92, 0.3);
            transform: translateY(-2px);
        }

        .export-btn .icon {
            font-size: 1.2rem;
        }

        .export-progress {
            text-align: center;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: none;
        }

        .export-progress.show {
            display: block;
        }

        .export-progress .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--bg-secondary);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @media (max-width: 500px) {
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .container { padding: 30px 15px; }
            .input-card, .personality-card, .ai-analysis, .life-number-display, .bazi-card, .fortune-card, .advice-card { padding: 25px 18px; }
            .bazi-pillars { gap: 8px; }
            .bazi-pillar { padding: 15px 5px; }
            .tiangan, .dizhi { font-size: 1.4rem; }
            .keywords { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="cosmic-bg"></div>
    <div class="stars" id="stars"></div>

    <div class="container">
        <header class="header">
            <div class="sacred-circle">
                <div class="sacred-inner"></div>
                <div class="bagua-symbol">â˜¯</div>
            </div>
            <h1>ç”Ÿå‘½æ•°å­—å¯†ç </h1>
            <div class="subtitle">å…«å­—äº”è¡Œ Â· æµå¹´è¿åŠ¿</div>
            <p>èåˆè¥¿æ–¹æ•°ç§˜æœ¯ä¸ä¸œæ–¹å‘½ç†æ™ºæ…§</p>
        </header>

        <div class="input-card">
            <div class="input-group full-width" style="margin-bottom: 30px;">
                <label>ç§°å‘¼ <span class="hint">(é€‰å¡«ï¼Œä»…ç”¨äºæ˜¾ç¤º)</span></label>
                <input type="text" class="name-input" id="userName" placeholder="è¯·è¾“å…¥ä½ çš„åå­—æˆ–æ˜µç§°" maxlength="20">
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label>å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" class="date-input" id="birthdate" required>
                </div>
                <div class="input-group">
                    <label>å‡ºç”Ÿæ—¶è¾° <span class="hint">(å¦‚ä¸ç¡®å®šå¯é€‰"æœªçŸ¥")</span></label>
                    <select class="time-select" id="birthHour">
                        <option value="-1">æœªçŸ¥</option>
                        <option value="0">å­æ—¶ (23:00-00:59)</option>
                        <option value="1">ä¸‘æ—¶ (01:00-02:59)</option>
                        <option value="2">å¯…æ—¶ (03:00-04:59)</option>
                        <option value="3">å¯æ—¶ (05:00-06:59)</option>
                        <option value="4">è¾°æ—¶ (07:00-08:59)</option>
                        <option value="5">å·³æ—¶ (09:00-10:59)</option>
                        <option value="6">åˆæ—¶ (11:00-12:59)</option>
                        <option value="7">æœªæ—¶ (13:00-14:59)</option>
                        <option value="8">ç”³æ—¶ (15:00-16:59)</option>
                        <option value="9">é…‰æ—¶ (17:00-18:59)</option>
                        <option value="10">æˆŒæ—¶ (19:00-20:59)</option>
                        <option value="11">äº¥æ—¶ (21:00-22:59)</option>
                    </select>
                </div>
            </div>
            <div class="input-group gender-group">
                <label>æ€§åˆ«</label>
                <div class="gender-options">
                    <label class="gender-option">
                        <input type="radio" name="gender" value="male" id="genderMale">
                        <span class="gender-btn">
                            <span class="gender-icon">â™‚</span>
                            <span>ç”·</span>
                        </span>
                    </label>
                    <label class="gender-option">
                        <input type="radio" name="gender" value="female" id="genderFemale">
                        <span class="gender-btn">
                            <span class="gender-icon">â™€</span>
                            <span>å¥³</span>
                        </span>
                    </label>
                </div>
            </div>
            <button class="calculate-btn" id="calculateBtn" onclick="calculateAll()">
                å¼€å¯å‘½è¿å¯†ç 
            </button>
        </div>

        <div class="result-section" id="resultSection">
            <div class="life-number-display">
                <div class="result-name" id="resultName"></div>
                <div class="gender-badge" id="genderBadge"></div>
                <div class="number-label">ä½ çš„ç”Ÿå‘½æ•°å­—</div>
                <div class="life-number" id="lifeNumber">-</div>
                <div class="calculation-process" id="calcProcess"></div>
                <div class="main-traits-section" id="mainTraitsSection" style="display:none;">
                    <div class="main-traits-title">ğŸ‘‘ ä¸»æ€§æ ¼ç‰¹è´¨</div>
                    <div class="main-traits-grid">
                        <div class="main-trait-box positive">
                            <span class="main-trait-label">âœ¨ æ­£é¢ç‰¹è´¨</span>
                            <span class="main-trait-content" id="mainPositiveTraits"></span>
                        </div>
                        <div class="main-trait-box negative">
                            <span class="main-trait-label">âš ï¸ è´Ÿé¢ç‰¹è´¨</span>
                            <span class="main-trait-content" id="mainNegativeTraits"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="numerology-card">
                <div class="card-title">ç”Ÿå‘½æ•°å­—å¯†ç è¯¦è§£</div>

                <div class="codes-wrapper">
                    <div class="code-grid" id="coreCodesGrid"></div>
                    <div class="code-item nine-grid-cell">
                        <div class="code-header">
                            <div class="code-name">ğŸ”¢ ç”Ÿå‘½ä¹å®«æ ¼</div>
                        </div>
                        <div class="nine-grid" id="nineGrid"></div>
                        <div class="grid-legend-inline" id="gridLegendContent">
                            æ¿€æ´»æ•°å­—è¶Šå¤šï¼Œèƒ½é‡è¶Šå®Œæ•´
                        </div>
                    </div>
                </div>

                <div class="union-section">
                    <div class="union-title">ğŸ”— åäºŒç»„è”åˆç </div>
                    <div class="union-codes" id="unionCodes"></div>
                </div>
            </div>

            <div class="bazi-card">
                <div class="card-title">ç”Ÿè¾°å…«å­—</div>
                <div class="bazi-pillars" id="baziPillars"></div>

                <div class="wuxing-analysis">
                    <div class="wuxing-title">äº”è¡Œåˆ†å¸ƒ</div>
                    <div class="wuxing-bars" id="wuxingBars"></div>
                </div>
            </div>

            <div class="fortune-card">
                <div class="card-title">äº”å¹´æµå¹´è¿åŠ¿</div>
                <div class="fortune-timeline" id="fortuneTimeline"></div>
            </div>

            <div class="personality-card">
                <div class="card-title">äººæ ¼ç‰¹è´¨</div>
                <div class="personality-name" id="personalityName"></div>
                <div class="keywords" id="keywords"></div>
                <div class="personality-desc" id="personalityDesc"></div>

                <div class="challenges-section">
                    <div class="challenges-title">äººç”ŸæŒ‘æˆ˜</div>
                    <div class="challenge-tags" id="challengeTags"></div>
                    <div class="challenges-desc" id="challengesDesc"></div>
                </div>
            </div>

            <div class="advice-card">
                <div class="card-title">ç»¼åˆå»ºè®®</div>
                <div class="advice-grid">
                    <div class="advice-section">
                        <div class="advice-section-title work">äº‹ä¸šå·¥ä½œ</div>
                        <div class="advice-content" id="workAdvice">æ­£åœ¨åˆ†æä¸­...</div>
                    </div>
                    <div class="advice-section">
                        <div class="advice-section-title life">ç”Ÿæ´»è°ƒå…»</div>
                        <div class="advice-content" id="lifeAdvice">æ­£åœ¨åˆ†æä¸­...</div>
                    </div>
                </div>
            </div>

            <div class="ai-analysis">
                <div class="card-title">å‘½ç†æ·±åº¦è§£è¯»</div>
                <div class="ai-content" id="aiContent">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">æ­£åœ¨è§£è¯»ä½ çš„å‘½è¿å¯†ç ...</div>
                    </div>
                </div>
            </div>

            <div class="blessing-section">
                <div class="blessing-divider"></div>
                <div class="blessing-title">ã€å¯„è¯­ã€‘</div>
                <div class="blessing-content">æ„¿ä½ åœ¨å‘½è¿çš„æŒ‡å¼•ä¸‹ï¼Œæ´»å‡ºçœŸå®çš„è‡ªå·±</div>
            </div>

            <div class="export-section">
                <div class="export-title">ä¿å­˜ä½ çš„å‘½è¿è§£è¯»</div>
                <div class="export-buttons">
                    <button class="export-btn image" id="exportImageBtn" onclick="exportAsImage()">
                        <span class="icon">ğŸ–¼ï¸</span>
                        <span>å¯¼å‡ºé•¿å›¾</span>
                    </button>
                    <button class="export-btn pdf" id="exportPdfBtn" onclick="exportAsPDF()">
                        <span class="icon">ğŸ“„</span>
                        <span>å¯¼å‡ºPDF</span>
                    </button>
                </div>
                <div class="export-progress" id="exportProgress">
                    <span class="spinner"></span>
                    <span id="exportProgressText">æ­£åœ¨ç”Ÿæˆ...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.add(event.matches ? 'dark' : '');
            if (!event.matches) document.documentElement.classList.remove('dark');
        });

        // Create stars
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 80; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (2 + Math.random() * 2) + 's';
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // Data Definitions
        const tianGan = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
        const diZhi = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
        const shiChen = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
        const tianGanWuxing = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };
        const diZhiWuxing = { 'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´' };
        const wuxingColors = { 'æœ¨': 'wood', 'ç«': 'fire', 'åœŸ': 'earth', 'é‡‘': 'metal', 'æ°´': 'water' };
        const wuxingIcons = { 'æœ¨': 'ğŸŒ¿', 'ç«': 'ğŸ”¥', 'åœŸ': 'ğŸŒ', 'é‡‘': 'âšª', 'æ°´': 'ğŸ’§' };

        // Logic Functions
        function getYearPillar(year, month, day) {
            let adjustedYear = year;
            if (month === 1 || (month === 2 && day < 4)) {
                adjustedYear = year - 1; 
            }
            const ganIndex = (adjustedYear - 4) % 10;
            const zhiIndex = (adjustedYear - 4) % 12;
            return { gan: tianGan[ganIndex], zhi: diZhi[zhiIndex] };
        }

        function getMonthPillar(year, month, day) {
            const jieQi = [
                { month: 1, day: 6, monthZhi: 1 }, { month: 2, day: 4, monthZhi: 2 },
                { month: 3, day: 6, monthZhi: 3 }, { month: 4, day: 5, monthZhi: 4 },
                { month: 5, day: 6, monthZhi: 5 }, { month: 6, day: 6, monthZhi: 6 },
                { month: 7, day: 7, monthZhi: 7 }, { month: 8, day: 8, monthZhi: 8 },
                { month: 9, day: 8, monthZhi: 9 }, { month: 10, day: 9, monthZhi: 10 },
                { month: 11, day: 8, monthZhi: 11 }, { month: 12, day: 7, monthZhi: 0 }
            ];
            let monthZhiIndex = 1; 
            let adjustedYear = year;
            for (let i = jieQi.length - 1; i >= 0; i--) {
                const jq = jieQi[i];
                if (month > jq.month || (month === jq.month && day >= jq.day)) {
                    monthZhiIndex = jq.monthZhi;
                    break;
                }
            }
            if (month === 1 && day < 6) { monthZhiIndex = 0; adjustedYear = year - 1; }
            else if (month === 1 || (month === 2 && day < 4)) { monthZhiIndex = 1; adjustedYear = year - 1; }
            const yearGanIndex = (adjustedYear - 4) % 10;
            let monthGanBase;
            if (yearGanIndex === 0 || yearGanIndex === 5) monthGanBase = 2;
            else if (yearGanIndex === 1 || yearGanIndex === 6) monthGanBase = 4;
            else if (yearGanIndex === 2 || yearGanIndex === 7) monthGanBase = 6;
            else if (yearGanIndex === 3 || yearGanIndex === 8) monthGanBase = 8;
            else monthGanBase = 0;
            let monthOffset;
            if (monthZhiIndex >= 2) monthOffset = monthZhiIndex - 2;
            else monthOffset = monthZhiIndex + 10;
            const monthGanIndex = (monthGanBase + monthOffset) % 10;
            return { gan: tianGan[monthGanIndex], zhi: diZhi[monthZhiIndex] };
        }

        function getDayPillar(year, month, day) {
            const baseDate = new Date(1900, 0, 1);
            const targetDate = new Date(year, month - 1, day);
            const diffDays = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
            const baseGanIndex = 0; const baseZhiIndex = 10;
            let ganIndex = (baseGanIndex + diffDays) % 10;
            let zhiIndex = (baseZhiIndex + diffDays) % 12;
            if (ganIndex < 0) ganIndex += 10;
            if (zhiIndex < 0) zhiIndex += 12;
            return { gan: tianGan[ganIndex], zhi: diZhi[zhiIndex] };
        }

        function getHourPillar(dayGan, hourIndex) {
            if (hourIndex < 0) return null;
            const dayGanIndex = tianGan.indexOf(dayGan);
            let hourGanBase;
            if (dayGanIndex === 0 || dayGanIndex === 5) hourGanBase = 0;
            else if (dayGanIndex === 1 || dayGanIndex === 6) hourGanBase = 2;
            else if (dayGanIndex === 2 || dayGanIndex === 7) hourGanBase = 4;
            else if (dayGanIndex === 3 || dayGanIndex === 8) hourGanBase = 6;
            else hourGanBase = 8;
            const hourGanIndex = (hourGanBase + hourIndex) % 10;
            return { gan: tianGan[hourGanIndex], zhi: shiChen[hourIndex] };
        }

        function getYearFortune(year) {
            const ganIndex = (year - 4) % 10;
            const zhiIndex = (year - 4) % 12;
            const gan = tianGan[ganIndex];
            const zhi = diZhi[zhiIndex];
            const wuxing = tianGanWuxing[gan];
            return { year: year, ganzhi: gan + zhi, wuxing: wuxing };
        }

        function reduceToLifeNumber(num) {
            const steps = [num.toString()];
            while (num > 9 && num !== 11 && num !== 22 && num !== 33) {
                num = num.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
                steps.push(num.toString());
            }
            return { number: num, steps: steps };
        }

        function reduceToSingleDigit(num) {
            while (num > 9) {
                num = num.toString().split('').reduce((a, b) => a + parseInt(b), 0);
            }
            return num;
        }

        function calculateNumerologyCodes(year, month, day) {
            const talentNum = reduceToSingleDigit(day);
            const innerNum = reduceToSingleDigit(month);
            const outerNum = reduceToSingleDigit(year.toString().split('').reduce((a, b) => a + parseInt(b), 0));
            const dateString = year.toString() + month.toString() + day.toString();
            const totalSum = dateString.split('').reduce((sum, digit) => sum + parseInt(digit), 0);
            const throneNum = totalSum > 9 ? Math.floor(totalSum / 10) % 10 || reduceToSingleDigit(totalSum) : totalSum;
            const allDigits = (year.toString() + month.toString() + day.toString()).split('').map(Number);
            const digitCounts = {};
            for (let i = 1; i <= 9; i++) digitCounts[i] = 0;
            allDigits.forEach(d => { if (d >= 1 && d <= 9) digitCounts[d]++; });
            const missingNums = [];
            for (let i = 1; i <= 9; i++) {
                if (digitCounts[i] === 0) missingNums.push(i);
            }
            return { talentNum, innerNum, outerNum, throneNum, missingNums, digitCounts };
        }

        function hasUnionCode(digitCounts, numbers) {
            return numbers.every(n => digitCounts[n] > 0);
        }

        function getWuxingRelation(element1, element2) {
            const shengRelation = { 'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘', 'é‡‘': 'æ°´', 'æ°´': 'æœ¨' };
            const keRelation = { 'æœ¨': 'åœŸ', 'åœŸ': 'æ°´', 'æ°´': 'ç«', 'ç«': 'é‡‘', 'é‡‘': 'æœ¨' };
            if (element1 === element2) return 'æ¯”å’Œ';
            if (shengRelation[element1] === element2 || shengRelation[element2] === element1) return 'ç›¸ç”Ÿ';
            return 'ç›¸å…‹';
        }

        // Data Objects
        const lifeNumberData = {
            1: { name: "é¢†è¢–è€… Â· å¼€åˆ›è€…", keywords: ["ç‹¬ç«‹", "åˆ›æ–°", "é¢†å¯¼åŠ›", "è‡ªä¿¡", "å‹‡æ°”", "å…ˆé©±"], description: "ç”Ÿå‘½æ•°å­—1ä»£è¡¨ç€åˆ›é€ ä¸å¼€å§‹çš„åŠ›é‡ã€‚ä½ æ‹¥æœ‰å¼ºå¤§çš„é¢†å¯¼æ‰èƒ½å’Œå¼€åˆ›ç²¾ç¥ï¼Œæ€»æ˜¯å‹‡äºèµ°åœ¨æœ€å‰é¢ã€‚", challenges: ["å›ºæ‰§å·±è§", "è¿‡åº¦è‡ªæˆ‘", "ç¼ºä¹è€å¿ƒ", "éš¾ä»¥åˆä½œ"], challengeDesc: "ä½ å¯èƒ½è¿‡äºåšæŒè‡ªå·±çš„æƒ³æ³•ï¼Œå¿½è§†ä»–äººæ„è§ï¼›æœ‰æ—¶ä¼šæ˜¾å¾—å‚²æ…¢æˆ–ç‹¬æ–­ï¼Œéœ€è¦å­¦ä¼šå€¾å¬ä¸åä½œã€‚" },
            2: { name: "åˆä½œè€… Â· è°ƒå’Œè€…", keywords: ["å’Œè°", "æ•æ„Ÿ", "åˆä½œ", "å¤–äº¤", "å¹³è¡¡", "ç›´è§‰"], description: "ç”Ÿå‘½æ•°å­—2è±¡å¾ç€å¹³è¡¡ä¸å’Œè°çš„åŠ›é‡ã€‚ä½ å¤©ç”Ÿå…·æœ‰æ•é”çš„æ´å¯ŸåŠ›å’ŒåŒç†å¿ƒï¼Œå–„äºè°ƒè§£çŸ›ç›¾ã€ä¿ƒè¿›åˆä½œã€‚", challenges: ["è¿‡åº¦æ•æ„Ÿ", "ä¼˜æŸ”å¯¡æ–­", "ä¾èµ–ä»–äºº", "è‡ªæˆ‘æ€€ç–‘"], challengeDesc: "ä½ å®¹æ˜“å—ä»–äººæƒ…ç»ªå½±å“ï¼Œåœ¨åšå†³å®šæ—¶çŠ¹è±«ä¸å†³ï¼›å¯èƒ½è¿‡åº¦åœ¨æ„åˆ«äººçš„çœ‹æ³•ï¼Œéœ€è¦å»ºç«‹å†…åœ¨çš„è‡ªä¿¡ã€‚" },
            3: { name: "è¡¨è¾¾è€… Â· åˆ›æ„å®¶", keywords: ["åˆ›æ„", "è¡¨è¾¾", "ä¹è§‚", "ç¤¾äº¤", "è‰ºæœ¯", "çµæ„Ÿ"], description: "ç”Ÿå‘½æ•°å­—3ä»£è¡¨ç€è¡¨è¾¾ä¸åˆ›é€ çš„èƒ½é‡ã€‚ä½ æ‹¥æœ‰ä¸°å¯Œçš„æƒ³è±¡åŠ›å’Œè‰ºæœ¯å¤©èµ‹ï¼Œå–„äºç”¨è¯­è¨€ã€è‰ºæœ¯æˆ–å…¶ä»–å½¢å¼è¡¨è¾¾è‡ªæˆ‘ã€‚", challenges: ["æ³¨æ„åŠ›åˆ†æ•£", "æµ®äºè¡¨é¢", "é€ƒé¿ç°å®", "æƒ…ç»ªæ³¢åŠ¨"], challengeDesc: "ä½ å¯èƒ½åŒæ—¶è¿½æ±‚å¤ªå¤šç›®æ ‡å¯¼è‡´ç²¾åŠ›åˆ†æ•£ï¼›æœ‰æ—¶ä¼šç”¨ä¹è§‚æ©ç›–é—®é¢˜ï¼Œéœ€è¦å­¦ä¼šæ·±å…¥å’Œä¸“æ³¨ã€‚" },
            4: { name: "å»ºé€ è€… Â· åŠ¡å®è€…", keywords: ["ç¨³å®š", "å®é™…", "å‹¤å¥‹", "ç»„ç»‡", "çºªå¾‹", "å¯é "], description: "ç”Ÿå‘½æ•°å­—4è±¡å¾ç€ç¨³å›ºçš„æ ¹åŸºä¸ç§©åºã€‚ä½ æ˜¯å¤©ç”Ÿçš„å»ºé€ è€…ï¼Œæ“…é•¿å°†æƒ³æ³•è½¬åŒ–ä¸ºç°å®ã€‚", challenges: ["è¿‡äºåˆ»æ¿", "æŠ—æ‹’å˜åŒ–", "å·¥ä½œç‹‚å€¾å‘", "ç¼ºä¹å¼¹æ€§"], challengeDesc: "ä½ å¯èƒ½è¿‡åº¦è¿½æ±‚å®Œç¾å’Œç§©åºï¼Œéš¾ä»¥é€‚åº”å˜åŒ–ï¼›æœ‰æ—¶ä¼šå› è¿‡åº¦å·¥ä½œè€Œå¿½è§†ç”Ÿæ´»çš„ä¹è¶£å’Œçµæ´»æ€§ã€‚" },
            5: { name: "è‡ªç”±è€… Â· å†’é™©å®¶", keywords: ["è‡ªç”±", "å˜åŒ–", "å†’é™©", "é€‚åº”", "å¤šæ‰", "æ´»åŠ›"], description: "ç”Ÿå‘½æ•°å­—5ä»£è¡¨ç€è‡ªç”±ä¸å˜åŒ–çš„åŠ›é‡ã€‚ä½ æ¸´æœ›æ¢ç´¢ç”Ÿå‘½çš„å„ç§å¯èƒ½æ€§ï¼Œä¸å–œæ¬¢ä¸€æˆä¸å˜çš„ç”Ÿæ´»ã€‚", challenges: ["ç¼ºä¹è€å¿ƒ", "è´£ä»»å¿ƒä¸è¶³", "è¿‡åº¦æ”¾çºµ", "éš¾ä»¥æ‰¿è¯º"], challengeDesc: "ä½ å¯èƒ½å› è¿½æ±‚è‡ªç”±è€Œé€ƒé¿è´£ä»»å’Œæ‰¿è¯ºï¼›å®¹æ˜“å¯¹äº‹ç‰©å¤±å»å…´è¶£ï¼Œéœ€è¦å­¦ä¼šåœ¨è‡ªç”±ä¸ç¨³å®šé—´æ‰¾åˆ°å¹³è¡¡ã€‚" },
            6: { name: "ç…§é¡¾è€… Â· å’Œè°è€…", keywords: ["è´£ä»»", "çˆ±", "å®¶åº­", "æ²»æ„ˆ", "ç¾æ„Ÿ", "æœåŠ¡"], description: "ç”Ÿå‘½æ•°å­—6è±¡å¾ç€çˆ±ä¸è´£ä»»çš„åŠ›é‡ã€‚ä½ å¤©ç”Ÿå…·æœ‰ç…§é¡¾ä»–äººçš„æœ¬èƒ½ï¼Œå¯¹å®¶åº­å’Œç¤¾åŒºæœ‰ç€æ·±æ·±çš„è´£ä»»æ„Ÿã€‚", challenges: ["è¿‡åº¦ç‰ºç‰²", "æ§åˆ¶æ¬²å¼º", "å®Œç¾ä¸»ä¹‰", "å¿½è§†è‡ªæˆ‘"], challengeDesc: "ä½ å¯èƒ½ä¸ºç…§é¡¾ä»–äººè€Œå¿½ç•¥è‡ªå·±çš„éœ€æ±‚ï¼›æœ‰æ—¶ä¼šä»¥çˆ±ä¹‹åæ§åˆ¶ä»–äººï¼Œéœ€è¦å­¦ä¼šå¥åº·çš„è¾¹ç•Œæ„Ÿã€‚" },
            7: { name: "æ¢ç´¢è€… Â· å“²å­¦å®¶", keywords: ["æ™ºæ…§", "å†…çœ", "ç¥ç§˜", "åˆ†æ", "çµæ€§", "çœŸç†"], description: "ç”Ÿå‘½æ•°å­—7ä»£è¡¨ç€æ™ºæ…§ä¸æ¢ç´¢çš„åŠ›é‡ã€‚ä½ æ‹¥æœ‰æ·±é‚ƒçš„æ€æƒ³å’Œæ•é”çš„åˆ†æèƒ½åŠ›ï¼Œæ€»æ˜¯åœ¨è¿½å¯»ç”Ÿå‘½çš„çœŸç†ã€‚", challenges: ["è¿‡åº¦å­¤åƒ»", "å¤šç–‘çŒœå¿Œ", "è„±ç¦»ç°å®", "æƒ…æ„Ÿå°é—­"], challengeDesc: "ä½ å¯èƒ½è¿‡åº¦æ²‰æµ¸åœ¨æ€è€ƒä¸­è€Œä¸ç°å®è„±èŠ‚ï¼›æœ‰æ—¶ä¼šå› æ€€ç–‘è€Œéš¾ä»¥ä¿¡ä»»ä»–äººï¼Œéœ€è¦å­¦ä¼šæ‰“å¼€å¿ƒæ‰‰ã€‚" },
            8: { name: "æˆå°±è€… Â· æŒæƒè€…", keywords: ["åŠ›é‡", "æˆå°±", "ä¸°ç››", "æƒå¨", "é‡å¿ƒ", "ç‰©è´¨"], description: "ç”Ÿå‘½æ•°å­—8è±¡å¾ç€åŠ›é‡ä¸ä¸°ç››çš„èƒ½é‡ã€‚ä½ æœ‰ç€å¼ºå¤§çš„æ‰§è¡ŒåŠ›å’Œå•†ä¸šå¤´è„‘ï¼Œè¿½æ±‚ç‰©è´¨ä¸ç²¾ç¥çš„åŒé‡æˆåŠŸã€‚", challenges: ["æƒåŠ›æ¬²è¿‡å¼º", "ç‰©è´¨ä¸»ä¹‰", "å·¥ä½œç‹‚", "å¿½è§†æƒ…æ„Ÿ"], challengeDesc: "ä½ å¯èƒ½è¿‡åº¦è¿½æ±‚æƒåŠ›å’Œè´¢å¯Œè€Œå¿½è§†äººé™…å…³ç³»ï¼›æœ‰æ—¶ä¼šå› é‡å¿ƒå¤ªå¤§è€Œç»™è‡ªå·±è¿‡å¤šå‹åŠ›ï¼Œéœ€è¦å¹³è¡¡ç‰©è´¨ä¸å¿ƒçµã€‚" },
            9: { name: "åšçˆ±è€… Â· æ™ºè€…", keywords: ["æ…ˆæ‚²", "æ™ºæ…§", "åŒ…å®¹", "äººé“", "å®Œç»“", "è¶…è¶Š"], description: "ç”Ÿå‘½æ•°å­—9ä»£è¡¨ç€åœ†æ»¡ä¸åšçˆ±çš„åŠ›é‡ã€‚ä½ æ‹¥æœ‰å®½å¹¿çš„è§†é‡å’Œæ…ˆæ‚²çš„å¿ƒæ€€ï¼Œå…³å¿ƒäººç±»çš„ç¦ç¥‰ã€‚", challenges: ["è¿‡åº¦ç†æƒ³åŒ–", "éš¾ä»¥æ”¾æ‰‹", "è‡ªæˆ‘ç‰ºç‰²", "æƒ…ç»ªåŒ–"], challengeDesc: "ä½ å¯èƒ½å› ç†æƒ³å¤ªé«˜è€Œå¯¹ç°å®å¤±æœ›ï¼›æœ‰æ—¶ä¼šè¿‡åº¦ä»˜å‡ºå´éš¾ä»¥æ¥å—å›æŠ¥ï¼Œéœ€è¦å­¦ä¼šå¥åº·åœ°ç…§é¡¾è‡ªå·±ã€‚" },
            11: { name: "ç›´è§‰å¤§å¸ˆ Â· çµæ€§ä½¿è€…", keywords: ["ç›´è§‰", "çµæ„Ÿ", "å¯ç¤º", "ç†æƒ³", "æ•æ„Ÿ", "ä½¿å‘½"], description: "ç”Ÿå‘½æ•°å­—11æ˜¯ç¥åœ£çš„ä¸»æ•°ï¼Œä»£è¡¨ç€çµæ€§çš„è§‰é†’ä¸æ›´é«˜çš„ä½¿å‘½ã€‚ä½ æ‹¥æœ‰éå‡¡çš„ç›´è§‰å’Œçµæ„Ÿã€‚", challenges: ["æåº¦æ•æ„Ÿ", "ç„¦è™‘ç´§å¼ ", "æ´»åœ¨å¹»æƒ³ä¸­", "è‡ªæˆ‘æ€€ç–‘"], challengeDesc: "ä½œä¸ºä¸»æ•°ï¼Œä½ æ‰¿å—ç€æ›´å¼ºçš„èƒ½é‡æŒ¯åŠ¨ï¼Œå®¹æ˜“æ„Ÿåˆ°ç„¦è™‘å’Œä¸å®‰ï¼›éœ€è¦å­¦ä¼šå°†çµæ€§æ´è§è½å®åˆ°ç°å®ç”Ÿæ´»ä¸­ã€‚" },
            22: { name: "å®‡å®™å»ºé€ è€… Â· æ¢¦æƒ³å®ç°è€…", keywords: ["æ„¿æ™¯", "å®è·µ", "å»ºè®¾", "ä¼Ÿå¤§", "è½¬åŒ–", "åŠ›é‡"], description: "ç”Ÿå‘½æ•°å­—22æ˜¯å¼ºå¤§çš„ä¸»æ•°ï¼Œè¢«ç§°ä¸º'å®‡å®™å»ºé€ è€…'ã€‚ä½ æ‹¥æœ‰å°†ä¼Ÿå¤§æ„¿æ™¯è½¬åŒ–ä¸ºç°å®çš„éå‡¡èƒ½åŠ›ã€‚", challenges: ["å‹åŠ›è¿‡å¤§", "å®Œç¾ä¸»ä¹‰æç«¯", "ç›®æ ‡è¿‡äºå®å¤§", "éš¾ä»¥æ»¡è¶³"], challengeDesc: "ä½ å¯èƒ½å› ä½¿å‘½æ„Ÿå¤ªå¼ºè€Œç»™è‡ªå·±æ–½åŠ å·¨å¤§å‹åŠ›ï¼›æœ‰æ—¶ä¼šå› ç›®æ ‡è¿‡äºå®å¤§è€Œéš¾ä»¥å¼€å§‹ï¼Œéœ€è¦å­¦ä¼šä»å°å¤„ç€æ‰‹ã€‚" },
            33: { name: "å¤§å¸ˆå¯¼å¸ˆ Â· æ…ˆæ‚²åŒ–èº«", keywords: ["æ…ˆæ‚²", "æ²»æ„ˆ", "å¥‰çŒ®", "æ•™å¯¼", "å‡å", "æ— æ¡ä»¶çš„çˆ±"], description: "ç”Ÿå‘½æ•°å­—33æ˜¯æœ€ç¥åœ£çš„ä¸»æ•°ï¼Œä»£è¡¨ç€æ— æ¡ä»¶çš„çˆ±ä¸æ…ˆæ‚²ã€‚ä½ è¢«èµ‹äºˆç–—æ„ˆå’Œæ•™å¯¼çš„ç¥åœ£ä½¿å‘½ã€‚", challenges: ["è¿‡åº¦å¥‰çŒ®", "æ®‰é“è€…æƒ…ç»“", "èƒ½é‡è€—ç«­", "è¾¹ç•Œæ¨¡ç³Š"], challengeDesc: "ä½ å¯èƒ½å› æ— æ¡ä»¶ä»˜å‡ºè€Œè€—å°½è‡ªå·±çš„èƒ½é‡ï¼›æœ‰æ—¶ä¼šé™·å…¥æ®‰é“è€…å¿ƒæ€ï¼Œéœ€è¦å­¦ä¼šåœ¨ç»™äºˆå’Œæ¥å—ä¹‹é—´æ‰¾åˆ°ç¥åœ£çš„å¹³è¡¡ã€‚" }
        };

        const coreCodeTraits = {
            1: { positive: "ç‹¬ç«‹è‡ªä¸»ã€é¢†å¯¼åŠ›å¼ºã€å‹‡äºåˆ›æ–°ã€å¼€æ‹“è¿›å–", negative: "å›ºæ‰§å·±è§ã€è‡ªæˆ‘ä¸­å¿ƒã€ç‹¬æ–­ä¸“è¡Œã€ç¼ºä¹è€å¿ƒ" },
            2: { positive: "å–„äºåˆä½œã€æ•æ„Ÿç»†è…»ã€å¯Œæœ‰åŒç†å¿ƒã€å–„è§£äººæ„", negative: "ä¼˜æŸ”å¯¡æ–­ã€è¿‡åº¦ä¾èµ–ã€å®¹æ˜“å—ä¼¤ã€ç¼ºä¹ä¸»è§" },
            3: { positive: "åˆ›æ„æ— é™ã€è¡¨è¾¾åŠ›å¼ºã€ä¹è§‚å¼€æœ—ã€ç¤¾äº¤èƒ½åŠ›ä½³", negative: "æ³¨æ„åŠ›åˆ†æ•£ã€è‚¤æµ…æµ®èºã€é€ƒé¿è´£ä»»ã€æƒ…ç»ªåŒ–" },
            4: { positive: "è¸å®å¯é ã€ç»„ç»‡åŠ›å¼ºã€å‹¤å¥‹åŠªåŠ›ã€æ³¨é‡ç»†èŠ‚", negative: "è¿‡äºåˆ»æ¿ã€æŠ—æ‹’å˜åŒ–ã€æ€æƒ³ä¿å®ˆã€å·¥ä½œç‹‚" },
            5: { positive: "è‡ªç”±å¥”æ”¾ã€é€‚åº”åŠ›å¼ºã€å¤šæ‰å¤šè‰ºã€å……æ»¡æ´»åŠ›", negative: "ç¼ºä¹æ’å¿ƒã€è´£ä»»æ„Ÿå¼±ã€è¿‡åº¦æ”¾çºµã€éš¾ä»¥æ‰¿è¯º" },
            6: { positive: "å¯Œæœ‰çˆ±å¿ƒã€è´£ä»»æ„Ÿå¼ºã€å®¶åº­è§‚å¿µé‡ã€ä¹äºåŠ©äºº", negative: "æ§åˆ¶æ¬²å¼ºã€è¿‡åº¦æ“å¿ƒã€å®Œç¾ä¸»ä¹‰ã€å¿½è§†è‡ªæˆ‘" },
            7: { positive: "æ™ºæ…§æ·±é‚ƒã€åˆ†æåŠ›å¼ºã€è¿½æ±‚çœŸç†ã€ç²¾ç¥æ€§é«˜", negative: "è¿‡åº¦å­¤åƒ»ã€å¤šç–‘çŒœå¿Œã€è„±ç¦»ç°å®ã€å†·æ¼ ç–ç¦»" },
            8: { positive: "æ‰§è¡ŒåŠ›å¼ºã€ç›®æ ‡æ˜ç¡®ã€å•†ä¸šå¤´è„‘ã€è¿½æ±‚æˆåŠŸ", negative: "æƒåŠ›æ¬²å¼ºã€ç‰©è´¨ä¸»ä¹‰ã€å¿½è§†æƒ…æ„Ÿã€å‹åŠ›è¿‡å¤§" },
            9: { positive: "èƒ¸æ€€åšå¤§ã€æ…ˆæ‚²ä¸ºæ€€ã€æ™ºæ…§è¶…ç¾¤ã€ç†æƒ³ä¸»ä¹‰", negative: "è¿‡åº¦ä»˜å‡ºã€éš¾ä»¥æ”¾æ‰‹ã€è„±ç¦»ç°å®ã€æƒ…ç»ªæ•æ„Ÿ" }
        };

        const unionCodeData = {
            '1-2-3': { name: "æ‰è‰ºçº¿", numbers: [1,2,3], brief: "åˆ›æ„å¤©èµ‹çªå‡ºï¼Œè¡¨è¾¾èƒ½åŠ›å¼º", positive: "åˆ›æ„è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œè‰ºæœ¯å¤©èµ‹é«˜ï¼Œæ²Ÿé€šè¡¨è¾¾æµç•…", negative: "å®¹æ˜“å¿ƒæµ®æ°”èºï¼Œç¼ºä¹è€å¿ƒï¼Œæƒ³æ³•å¤šä½†æ‰§è¡ŒåŠ›å¼±" },
            '4-5-6': { name: "ç»„ç»‡çº¿", numbers: [4,5,6], brief: "ç®¡ç†åè°ƒé«˜æ‰‹ï¼Œåšäº‹æœ‰æ¡ç†", positive: "ç»„ç»‡èƒ½åŠ›å¼ºï¼Œåšäº‹æœ‰æ¡ç†ï¼Œå–„äºç®¡ç†å’Œåè°ƒ", negative: "è¿‡äºè¿½æ±‚å®Œç¾ï¼Œå¯èƒ½å˜å¾—æŒ‘å‰”ï¼Œå¯¹è‡ªå·±å’Œä»–äººè¦æ±‚è¿‡é«˜" },
            '7-8-9': { name: "è´µäººçº¿", numbers: [7,8,9], brief: "è´µäººè¿æ—ºç››ï¼Œäººè„‰èµ„æºä¸°å¯Œ", positive: "è´µäººè¿å¼ºï¼Œå®¹æ˜“è·å¾—ä»–äººå¸®åŠ©ï¼Œäººè„‰å¹¿æ³›", negative: "å¯èƒ½è¿‡äºä¾èµ–ä»–äººï¼Œç‹¬ç«‹æ€§ä¸è¶³ï¼Œæ˜“å—ä»–äººå½±å“" },
            '1-4-7': { name: "è¡ŒåŠ¨çº¿", numbers: [1,4,7], brief: "æ‰§è¡ŒåŠ›å¼ºï¼Œæƒ³æ³•èƒ½è½åœ°å®ç°", positive: "è¡ŒåŠ¨åŠ›å¼ºï¼Œå®è·µèƒ½åŠ›ä½³ï¼Œèƒ½å°†æƒ³æ³•å˜ä¸ºç°å®", negative: "å¯èƒ½è¿‡äºæ€¥èºï¼Œç¼ºä¹æ·±æ€ç†Ÿè™‘ï¼Œå®¹æ˜“å†²åŠ¨è¡Œäº‹" },
            '2-5-8': { name: "æƒ…æ„Ÿçº¿", numbers: [2,5,8], brief: "æƒ…æ„Ÿç»†è…»ä¸°å¯Œï¼Œäººé™…å’Œè°", positive: "æƒ…æ„Ÿä¸°å¯Œï¼Œå–„äºä½“å¯Ÿä»–äººæ„Ÿå—ï¼Œäººé™…å…³ç³»å’Œè°", negative: "æƒ…ç»ªæ³¢åŠ¨å¤§ï¼Œå®¹æ˜“å—æ„Ÿæƒ…å½±å“å†³ç­–ï¼Œæœ‰æ—¶ä¼˜æŸ”å¯¡æ–­" },
            '3-6-9': { name: "æ™ºæ…§çº¿", numbers: [3,6,9], brief: "æ™ºæ…§è¿‡äººï¼Œå­¦ä¹ é¢†æ‚ŸåŠ›å¼º", positive: "æ™ºæ…§è¿‡äººï¼Œå­¦ä¹ èƒ½åŠ›å¼ºï¼Œæ€ç»´æ•æ·æœ‰æ·±åº¦", negative: "å¯èƒ½è¿‡äºç†æƒ³åŒ–ï¼Œæœ‰æ—¶è„±ç¦»å®é™…ï¼Œæƒ³å¤ªå¤šä¸è¡ŒåŠ¨" },
            '1-5-9': { name: "äº‹ä¸šçº¿", numbers: [1,5,9], brief: "äº‹ä¸šå¿ƒå¼ºï¼Œé€‚åˆåˆ›ä¸šé¢†å¯¼", positive: "äº‹ä¸šå¿ƒå¼ºï¼Œæœ‰è¿œå¤§æŠ±è´Ÿï¼Œé€‚åˆåˆ›ä¸šå’Œé¢†å¯¼", negative: "å¯èƒ½å·¥ä½œç‹‚å€¾å‘ï¼Œå¿½è§†å®¶åº­å’Œå¥åº·ï¼Œç»™è‡ªå·±å¤ªå¤§å‹åŠ›" },
            '3-5-7': { name: "äººç¼˜çº¿", numbers: [3,5,7], brief: "ç¤¾äº¤è¾¾äººï¼Œæ˜“è·ä»–äººå¥½æ„Ÿ", positive: "äººç¼˜æä½³ï¼Œç¤¾äº¤èƒ½åŠ›å¼ºï¼Œå®¹æ˜“è·å¾—ä»–äººå¥½æ„Ÿ", negative: "å¯èƒ½è¿‡äºåœ¨æ„ä»–äººçœ‹æ³•ï¼Œæœ‰æ—¶ä¼šå§”å±ˆè‡ªå·±è¿åˆä»–äºº" },
            '1-2': { name: "æ²Ÿé€šçº¿", numbers: [1,2], brief: "å–„äºè¡¨è¾¾å€¾å¬ï¼Œæ²Ÿé€šæ— éšœç¢", positive: "æ²Ÿé€šèƒ½åŠ›å¼ºï¼Œå–„äºè¡¨è¾¾å’Œå€¾å¬ï¼Œäººé™…å…³ç³»ä½³", negative: "å¯èƒ½è¯å¤šï¼Œæœ‰æ—¶ä¸æ‡‚å¾—é€‚æ—¶ä¿æŒæ²‰é»˜" },
            '2-3': { name: "è‰ºæœ¯çº¿", numbers: [2,3], brief: "å®¡ç¾ç‹¬åˆ°ï¼Œè‰ºæœ¯åˆ›é€ åŠ›å¼º", positive: "è‰ºæœ¯å¤©èµ‹é«˜ï¼Œå®¡ç¾èƒ½åŠ›å¼ºï¼Œåˆ›é€ åŠ›ä¸°å¯Œ", negative: "å¯èƒ½è¿‡äºæ„Ÿæ€§ï¼Œå®åŠ¡èƒ½åŠ›ç›¸å¯¹è¾ƒå¼±" },
            '1-3': { name: "æ¡ƒèŠ±çº¿", numbers: [1,3], brief: "é­…åŠ›å‡ºä¼—ï¼Œå¼‚æ€§ç¼˜æä½³", positive: "é­…åŠ›å››å°„ï¼Œå¼‚æ€§ç¼˜å¥½ï¼Œæ„Ÿæƒ…ç”Ÿæ´»ä¸°å¯Œ", negative: "å¯èƒ½æ„Ÿæƒ…ä¸Šä¸å¤Ÿä¸“ä¸€ï¼Œå®¹æ˜“è¢«å¤–åœ¨å¸å¼•" },
            '4-6': { name: "è´¢å¯Œçº¿", numbers: [4,6], brief: "ç†è´¢æœ‰é“ï¼Œå–„äºç§¯ç´¯è´¢å¯Œ", positive: "ç†è´¢èƒ½åŠ›å¼ºï¼Œå–„äºç§¯ç´¯è´¢å¯Œï¼Œç‰©è´¨åŸºç¡€ç¨³å›º", negative: "å¯èƒ½è¿‡äºçœ‹é‡é‡‘é’±ï¼Œæœ‰æ—¶æ˜¾å¾—è¿‡äºèŠ‚ä¿­æˆ–å®ˆè´¢" }
        };

        const missingNumberMeaning = {
            1: { meaning: "ç¼ºä¹è‡ªä¿¡å’Œç‹¬ç«‹æ€§", lesson: "å­¦ä¹ ç›¸ä¿¡è‡ªå·±ï¼ŒåŸ¹å…»ç‹¬ç«‹ç²¾ç¥" },
            2: { meaning: "ç¼ºä¹è€å¿ƒå’Œåˆä½œç²¾ç¥", lesson: "å­¦ä¹ å€¾å¬ä»–äººï¼ŒåŸ¹å…»åŒç†å¿ƒ" },
            3: { meaning: "ç¼ºä¹åˆ›æ„å’Œè¡¨è¾¾èƒ½åŠ›", lesson: "å­¦ä¹ è¡¨è¾¾è‡ªæˆ‘ï¼Œé‡Šæ”¾åˆ›é€ åŠ›" },
            4: { meaning: "ç¼ºä¹ç¨³å®šæ€§å’Œæ¡ç†æ€§", lesson: "å­¦ä¹ è„šè¸å®åœ°ï¼Œå»ºç«‹ç§©åºæ„Ÿ" },
            5: { meaning: "ç¼ºä¹å˜é€šå’Œå†’é™©ç²¾ç¥", lesson: "å­¦ä¹ æ¥å—å˜åŒ–ï¼Œå‹‡äºå°è¯•æ–°äº‹ç‰©" },
            6: { meaning: "ç¼ºä¹è´£ä»»æ„Ÿå’Œå®¶åº­è§‚å¿µ", lesson: "å­¦ä¹ æ‰¿æ‹…è´£ä»»ï¼Œå…³çˆ±å®¶äºº" },
            7: { meaning: "ç¼ºä¹å†…çœå’Œç²¾ç¥è¿½æ±‚", lesson: "å­¦ä¹ ç‹¬å¤„æ€è€ƒï¼Œè¿½å¯»å†…åœ¨æ™ºæ…§" },
            8: { meaning: "ç¼ºä¹ç›®æ ‡æ„Ÿå’Œç‰©è´¨è¿½æ±‚", lesson: "å­¦ä¹ è®¾å®šç›®æ ‡ï¼Œè¿½æ±‚ç‰©è´¨ä¸ç²¾ç¥å¹³è¡¡" },
            9: { meaning: "ç¼ºä¹åšçˆ±å’ŒåŒ…å®¹å¿ƒ", lesson: "å­¦ä¹ æ”¾ä¸‹æ‰§ç€ï¼ŒåŸ¹å…»å¤§çˆ±ç²¾ç¥" }
        };

        const wuxingAdvice = {
            'æœ¨': {
                male: { work: 'é€‚åˆä»äº‹åˆ›æ„ã€æ•™è‚²ã€æ–‡åŒ–ã€ç¯ä¿ã€åŒ»ç–—ç­‰è¡Œä¸šã€‚æœ¨ä¸»ç”Ÿå‘ï¼Œå®œä¸»åŠ¨å¼€æ‹“æ–°é¢†åŸŸï¼Œå‘æŒ¥é¢†å¯¼åŠ›ã€‚', life: 'å¤šäº²è¿‘è‡ªç„¶ï¼Œé€‚å½“æ™¨èµ·è¿åŠ¨å¦‚è·‘æ­¥ã€ç™»å±±ã€‚é¥®é£Ÿå®œå¤šç»¿è‰²è”¬èœï¼Œå…»è‚æŠ¤ç›®ã€‚æƒ…ç»ªä¸Šå­¦ä¼šç–å¯¼æ€’æ°”ã€‚' },
                female: { work: 'é€‚åˆä»äº‹åˆ›æ„è®¾è®¡ã€æ•™è‚²ã€æ–‡åŒ–è‰ºæœ¯ã€å¥åº·ç¾å®¹ç­‰è¡Œä¸šã€‚æœ¨ä¸»ç”Ÿå‘ï¼Œå®œå±•ç°æŸ”éŸ§ä¹‹åŠ›ï¼Œä»¥åˆ›æ„å–èƒœã€‚', life: 'å¤šäº²è¿‘èŠ±è‰æ¤ç‰©ï¼Œç»ƒä¹ ç‘œä¼½æˆ–å¤ªæã€‚é¥®é£Ÿå®œæ¸…æ·¡ï¼Œå¤šé£Ÿç»¿è‰²è”¬èœã€‚æ³¨æ„è°ƒèŠ‚æƒ…ç»ªï¼Œä¿æŒå¿ƒæ€å¹³å’Œã€‚' }
            },
            'ç«': {
                male: { work: 'é€‚åˆä»äº‹è¥é”€ã€ä¼ åª’ã€æ¼”è‰ºã€ç§‘æŠ€åˆ›æ–°ç­‰è¡Œä¸šã€‚ç«ä¸»çƒ­æƒ…ï¼Œå®œå¤§èƒ†å±•ç°é­…åŠ›ï¼ŒæŠŠæ¡æœºé‡è¿›å–ã€‚', life: 'æ³¨æ„å¿ƒè„ä¿å…»ï¼Œé¿å…ç†¬å¤œã€‚é€‚åº¦è¿åŠ¨ä½†ä¸å®œè¿‡äºæ¿€çƒˆã€‚å­¦ä¼šé™å¿ƒå†¥æƒ³ï¼Œå¹³è¡¡è¿‡æ—ºä¹‹ç«ã€‚' },
                female: { work: 'é€‚åˆä»äº‹å…¬å…³ã€ä¼ åª’ã€æ—¶å°šã€é¤é¥®æœåŠ¡ç­‰è¡Œä¸šã€‚ç«ä¸»çƒ­æƒ…ï¼Œå®œå‘æŒ¥äº²å’ŒåŠ›å’Œæ„ŸæŸ“åŠ›ã€‚', life: 'æ³¨æ„å¿ƒè¡€ç®¡å’Œæ°”è‰²è°ƒå…»ã€‚å¤å­£æ³¨æ„é˜²æ™’å…»é¢œã€‚ä¿æŒä¹è§‚å¼€æœ—ï¼Œä½†é¿å…æƒ…ç»ªå¤§èµ·å¤§è½ã€‚' }
            },
            'åœŸ': {
                male: { work: 'é€‚åˆä»äº‹æˆ¿åœ°äº§ã€å†œä¸šã€å»ºç­‘ã€é‡‘èæŠ•èµ„ç­‰è¡Œä¸šã€‚åœŸä¸»ç¨³é‡ï¼Œå®œæ·±è€•ç»†ä½œï¼Œåšé•¿è¿œè§„åˆ’ã€‚', life: 'æ³¨æ„è„¾èƒƒè°ƒå…»ï¼Œé¥®é£Ÿè§„å¾‹ã€‚é€‚å½“æˆ·å¤–æ´»åŠ¨ã€‚åŸ¹å…»è€å¿ƒï¼Œåœ¨ç¨³å®šä¸­å¯»æ±‚å‘å±•ã€‚' },
                female: { work: 'é€‚åˆä»äº‹äººåŠ›èµ„æºã€è¡Œæ”¿ç®¡ç†ã€æ•™è‚²ã€ç¾é£Ÿç­‰è¡Œä¸šã€‚åœŸä¸»åŒ…å®¹ï¼Œå®œå‘æŒ¥åè°ƒå’ŒåŸ¹è‚²èƒ½åŠ›ã€‚', life: 'æ³¨æ„è„¾èƒƒå’Œæ¶ˆåŒ–ç³»ç»Ÿã€‚é¥®é£Ÿè§„å¾‹ï¼Œå¤šé£Ÿæ¸©è¡¥ä¹‹å“ã€‚ä¿æŒå¿ƒæ€ç¨³å®šï¼Œäº«å—ç”Ÿæ´»çš„è¸å®æ„Ÿã€‚' }
            },
            'é‡‘': {
                male: { work: 'é€‚åˆä»äº‹é‡‘èã€æ³•å¾‹ã€ç®¡ç†ã€ç§‘æŠ€ç²¾å¯†ç±»å·¥ä½œã€‚é‡‘ä¸»å†³æ–­ï¼Œå®œå‘æŒ¥æœæ•¢å’Œæ‰§è¡ŒåŠ›ã€‚', life: 'æ³¨æ„å‘¼å¸ç³»ç»Ÿä¿å…»ï¼Œå¤šåšæ·±å‘¼å¸ã€‚ç§‹å­£æ³¨æ„æ¶¦è‚ºã€‚å­¦ä¼šæŸ”å’Œå¤„äº‹ï¼ŒåˆšæŸ”å¹¶æµã€‚' },
                female: { work: 'é€‚åˆä»äº‹è´¢åŠ¡ã€ç å®ã€æ—¶å°šã€æ³•å¾‹ç­‰è¡Œä¸šã€‚é‡‘ä¸»ç²¾è‡´ï¼Œå®œå‘æŒ¥ç»†è…»å’Œå®¡ç¾èƒ½åŠ›ã€‚', life: 'æ³¨æ„çš®è‚¤å’Œå‘¼å¸ç³»ç»Ÿä¿å…»ã€‚ç§‹å­£æ³¨æ„æ¶¦è‚ºæ¶¦è‚¤ã€‚é€‚å½“ä½©æˆ´é‡‘é“¶é¥°å“ï¼Œå¢æ·»æ°”åœºã€‚' }
            },
            'æ°´': {
                male: { work: 'é€‚åˆä»äº‹å’¨è¯¢ã€ç ”ç©¶ã€æµé€šã€æ—…æ¸¸ã€ç§‘æŠ€ç­‰è¡Œä¸šã€‚æ°´ä¸»æ™ºæ…§ï¼Œå®œå‘æŒ¥æ´å¯ŸåŠ›å’Œåº”å˜èƒ½åŠ›ã€‚', life: 'æ³¨æ„è‚¾è„ä¿å…»ã€‚å†¬å­£æ³¨æ„ä¿æš–ï¼Œé€‚å½“æ¸©è¡¥ã€‚ä¿æŒæ€ç»´æ•æ·ï¼Œä½†é¿å…è¿‡åº¦å¿§è™‘ã€‚' },
                female: { work: 'é€‚åˆä»äº‹å’¨è¯¢ã€ä¼ åª’ã€ç¾å®¹SPAã€å¿ƒç†è¾…å¯¼ç­‰è¡Œä¸šã€‚æ°´ä¸»æ™ºæ…§ï¼Œå®œå‘æŒ¥ç›´è§‰å’Œæ²Ÿé€šèƒ½åŠ›ã€‚', life: 'æ³¨æ„è‚¾è„å’Œå†…åˆ†æ³Œè°ƒå…»ã€‚å†¬å­£æ³¨æ„ä¿æš–å…»è‚¾ã€‚ä¿æŒå¿ƒå¢ƒå¦‚æ°´ï¼ŒæŸ”è€Œä¸å¼±ã€‚' }
            }
        };

        const fortuneDescriptions = {
            'ç›¸ç”Ÿ': ['è¿åŠ¿é¡ºé‚ï¼Œè´µäººç›¸åŠ©ï¼Œäº‹ä¸šæœ‰è¿›å±•çš„è‰¯å¥½æ—¶æœºã€‚', 'è´¢è¿ç¨³å¥ï¼Œé€‚åˆç¨³æ­¥å‘å±•ï¼Œä¸å®œå†’è¿›ã€‚', 'äººé™…å…³ç³»å’Œè°ï¼Œåˆä½œæœºä¼šå¢å¤šã€‚'],
            'ç›¸å…‹': ['æŒ‘æˆ˜ä¸æœºé‡å¹¶å­˜ï¼Œéœ€è°¨æ…å†³ç­–ã€‚', 'æ³¨æ„å¥åº·å’Œæƒ…ç»ªç®¡ç†ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯ã€‚', 'å¯èƒ½é¢ä¸´å˜åŠ¨ï¼Œä½†å±æœºä¸­è•´å«è½¬æœºã€‚'],
            'æ¯”å’Œ': ['ç¨³å®šæœŸï¼Œé€‚åˆå·©å›ºç°æœ‰æˆæœã€‚', 'è‡ªæˆ‘æå‡çš„å¥½æ—¶æœºï¼Œå®œå­¦ä¹ å……ç”µã€‚', 'ä¿æŒç°çŠ¶ï¼Œç­‰å¾…æ›´å¥½æ—¶æœºã€‚']
        };

        // State
        let baziData = null;
        let lifeNumber = null;
        let birthInfo = null;
        let selectedGender = null;
        let numerologyData = null;

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:var(--bg-card);padding:30px 40px;border-radius:15px;border:1px solid var(--accent-gold);max-width:90%;text-align:center;">
                    <p style="color:var(--text-primary);margin-bottom:20px;font-size:1rem;">${message}</p>
                    <button onclick="this.closest('div').parentElement.remove()" style="padding:10px 30px;background:var(--accent-gold);color:var(--bg-primary);border:none;border-radius:8px;cursor:pointer;font-family:inherit;font-size:1rem;">ç¡®å®š</button>
                </div>`;
            document.body.appendChild(modal);
        }

        // --- Render Functions ---

        function renderNumerologyCodes() {
            const gridEl = document.getElementById('coreCodesGrid');
            const nineGridEl = document.getElementById('nineGrid');
            const unionCodesEl = document.getElementById('unionCodes');
            const codes = [
                { icon: 'ğŸ', name: 'å¤©èµ‹ç ', number: numerologyData.talentNum, desc: 'ä¸ç”Ÿä¿±æ¥çš„å¤©èµ‹èƒ½åŠ›' },
                { icon: 'ğŸ’–', name: 'å†…å¿ƒç ', number: numerologyData.innerNum, desc: 'å†…å¿ƒæ·±å¤„çš„æ¸´æœ›' },
                { icon: 'ğŸ­', name: 'å¤–åœ¨ç ', number: numerologyData.outerNum, desc: 'ä»–äººçœ¼ä¸­çš„ä½ ' },
                { icon: 'ğŸ”®', name: 'æ½œæ„è¯†ç ', number: numerologyData.missingNums.length > 0 ? numerologyData.missingNums.join(',') : 'æ— ', desc: 'éœ€è¦å­¦ä¹ çš„äººç”Ÿè¯¾é¢˜', isMissing: true },
                { icon: 'ğŸ°', name: 'åº§é•‡ç ', number: numerologyData.throneNum, desc: 'å®ˆæŠ¤ä½ çš„æ ¸å¿ƒåŠ›é‡' }
            ];

            gridEl.innerHTML = codes.map((code, index) => {
                const num = code.isMissing ? null : (typeof code.number === 'number' ? code.number : parseInt(code.number));
                const traits = num && num <= 9 ? coreCodeTraits[num] : null;
                let traitsHtml = '';
                if (code.isMissing && numerologyData.missingNums.length > 0) {
                    traitsHtml = `
                        <div class="missing-numbers">${numerologyData.missingNums.map(n => `<span class="missing-number">${n}</span>`).join('')}</div>
                        <div class="trait-section trait-negative"><div class="trait-label">âš ï¸ éœ€è¦å­¦ä¹ çš„è¯¾é¢˜</div><div class="trait-content">${numerologyData.missingNums.map(n => missingNumberMeaning[n].lesson).join('ï¼›')}</div></div>`;
                } else if (code.isMissing && numerologyData.missingNums.length === 0) {
                    traitsHtml = `<div class="no-missing">âœ¨ æ­å–œï¼ä½ çš„ç”Ÿæ—¥åŒ…å«1-9æ‰€æœ‰æ•°å­—ï¼Œèƒ½é‡å®Œæ•´</div>`;
                } else if (traits) {
                    traitsHtml = `<div class="code-traits"><div class="trait-section trait-positive"><div class="trait-label">âœ¨ æ­£é¢ç‰¹è´¨</div><div class="trait-content">${traits.positive}</div></div><div class="trait-section trait-negative"><div class="trait-label">âš ï¸ è´Ÿé¢ç‰¹è´¨</div><div class="trait-content">${traits.negative}</div></div></div>`;
                }
                return `<div class="code-item"><div class="code-header"><div class="code-name">${code.icon} ${code.name}</div><div class="code-number">${code.number}</div></div><div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">${code.desc}</div>${traitsHtml}</div>`;
            }).join('');

            const gridOrder = [3, 6, 9, 2, 5, 8, 1, 4, 7];
            nineGridEl.innerHTML = gridOrder.map(num => {
                const count = numerologyData.digitCounts[num];
                const isActive = count > 0;
                return `<div class="grid-cell ${isActive ? 'active' : ''}">${num}${count > 1 ? `<span class="count">Ã—${count}</span>` : ''}${isActive ? '<span class="active-dot"></span>' : ''}</div>`;
            }).join('');

            const activeNums = Object.entries(numerologyData.digitCounts).filter(([k,v]) => v > 0).length;
            const legendContent = document.getElementById('gridLegendContent');
            if (legendContent) {
                if (numerologyData.missingNums.length === 0) legendContent.innerHTML = `æ¿€æ´»: ${activeNums}/9 âœ¨èƒ½é‡å®Œæ•´`;
                else legendContent.innerHTML = `æ¿€æ´»: ${activeNums}/9 Â· ç¼º: ${numerologyData.missingNums.join(',')}`;
            }

            unionCodesEl.innerHTML = Object.entries(unionCodeData).map(([key, data]) => {
                const has = hasUnionCode(numerologyData.digitCounts, data.numbers);
                return `<div class="union-code-item ${has ? 'active' : 'inactive'}"><div class="union-code-header"><span class="union-code-name">${data.name}</span><span class="union-code-numbers">${data.numbers.join('-')}</span></div><div class="union-code-desc">${has ? data.brief : 'æœªæ¿€æ´»'}</div></div>`;
            }).join('');
        }

        function renderMainTraits() {
            const mainNum = lifeNumber > 9 ? reduceToSingleDigit(lifeNumber) : lifeNumber;
            const traits = coreCodeTraits[mainNum];
            if (traits) {
                document.getElementById('mainPositiveTraits').textContent = traits.positive;
                document.getElementById('mainNegativeTraits').textContent = traits.negative;
                document.getElementById('mainTraitsSection').style.display = 'block';
            }
        }

        function renderBazi() {
            const pillarsEl = document.getElementById('baziPillars');
            const pillars = [
                { label: 'å¹´æŸ±', data: baziData.year }, { label: 'æœˆæŸ±', data: baziData.month },
                { label: 'æ—¥æŸ±', data: baziData.day }, { label: 'æ—¶æŸ±', data: baziData.hour }
            ];
            pillarsEl.innerHTML = pillars.map(p => {
                if (!p.data) return `<div class="bazi-pillar"><div class="pillar-label">${p.label}</div><div class="pillar-chars"><span class="tiangan" style="color: var(--text-secondary);">?</span><span class="dizhi" style="color: var(--text-secondary);">?</span></div><span class="element-badge" style="background: rgba(150,150,150,0.2); color: #999;">æœªçŸ¥</span></div>`;
                const ganWuxing = tianGanWuxing[p.data.gan];
                const zhiWuxing = diZhiWuxing[p.data.zhi];
                return `<div class="bazi-pillar"><div class="pillar-label">${p.label}</div><div class="pillar-chars"><span class="tiangan" style="color: var(--${wuxingColors[ganWuxing]})">${p.data.gan}</span><span class="dizhi" style="color: var(--${wuxingColors[zhiWuxing]})">${p.data.zhi}</span></div><span class="element-badge element-${wuxingColors[ganWuxing]}">${ganWuxing}${zhiWuxing}</span></div>`;
            }).join('');
        }

        function renderWuxing() {
            const barsEl = document.getElementById('wuxingBars');
            const counts = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
            const pillars = [baziData.year, baziData.month, baziData.day, baziData.hour].filter(p => p);
            pillars.forEach(p => { counts[tianGanWuxing[p.gan]]++; counts[diZhiWuxing[p.zhi]]++; });
            const maxCount = Math.max(...Object.values(counts));
            barsEl.innerHTML = Object.entries(counts).map(([element, count]) => {
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                const colorClass = wuxingColors[element];
                return `<div class="wuxing-bar"><div class="wuxing-label"><span class="wuxing-icon" style="background: var(--${colorClass}); color: #000;">${wuxingIcons[element]}</span>${element}</div><div class="wuxing-track"><div class="wuxing-fill" style="width: ${percentage}%; background: var(--${colorClass});"></div></div><div class="wuxing-count">${count}</div></div>`;
            }).join('');
        }

        function renderFortune() {
            const timelineEl = document.getElementById('fortuneTimeline');
            const currentYear = new Date().getFullYear();
            const dayMasterWuxing = tianGanWuxing[baziData.dayMaster];
            const years = [];
            for (let i = -2; i <= 2; i++) years.push(currentYear + i);
            timelineEl.innerHTML = years.map(y => {
                const fortune = getYearFortune(y);
                const relation = getWuxingRelation(dayMasterWuxing, fortune.wuxing);
                const descriptions = fortuneDescriptions[relation];
                const desc = descriptions[Math.abs(y - currentYear) % descriptions.length];
                let status, statusText;
                if (y < currentYear) { status = 'past'; statusText = 'å·²è¿‡'; }
                else if (y === currentYear) { status = 'current'; statusText = 'ä»Šå¹´'; }
                else { status = 'future'; statusText = 'æœªæ¥'; }
                return `<div class="fortune-year ${status}"><div class="year-header"><span class="year-label">${y}å¹´ Â· ${fortune.ganzhi}å¹´</span><div><span class="year-element element-${wuxingColors[fortune.wuxing]}">${wuxingIcons[fortune.wuxing]} ${fortune.wuxing}è¿</span><span class="year-status ${status}">${statusText}</span></div></div><div class="year-content"><strong>${fortune.wuxing}å¹´</strong>ä¸æ—¥ä¸»<strong>${dayMasterWuxing}</strong>å½¢æˆ<em>${relation}</em>æ ¼å±€ã€‚${desc}</div><div class="fortune-aspect"><div class="aspect-label">æµå¹´å…³é”®è¯</div>${relation === 'ç›¸ç”Ÿ' ? 'âœ¨ é¡ºé‚ Â· å‘å±• Â· æœºé‡' : relation === 'ç›¸å…‹' ? 'âš¡ å˜åŠ¨ Â· æŒ‘æˆ˜ Â· çªç ´' : 'ğŸ”„ ç¨³å®š Â· ç§¯ç´¯ Â· æ²‰æ·€'}</div></div>`;
            }).join('');
        }

        function renderAdvice() {
            const dayMasterWuxing = tianGanWuxing[baziData.dayMaster];
            const genderKey = selectedGender || 'male';
            const elementAdvice = wuxingAdvice[dayMasterWuxing] || wuxingAdvice['åœŸ'];
            const advice = elementAdvice[genderKey] || elementAdvice.male;
            document.getElementById('workAdvice').textContent = advice.work;
            document.getElementById('lifeAdvice').textContent = advice.life;
        }

        function calculateAll() {
            const dateInput = document.getElementById('birthdate');
            const hourInput = document.getElementById('birthHour');
            const genderInputs = document.querySelectorAll('input[name="gender"]');
            let genderValue = null;
            genderInputs.forEach(input => { if (input.checked) genderValue = input.value; });

            if (!dateInput.value) { showCustomAlert('è¯·é€‰æ‹©ä½ çš„å‡ºç”Ÿæ—¥æœŸ'); return; }
            if (!genderValue) { showCustomAlert('è¯·é€‰æ‹©ä½ çš„æ€§åˆ«'); return; }

            selectedGender = genderValue;
            const date = new Date(dateInput.value);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hourIndex = parseInt(hourInput.value);
            birthInfo = { year, month, day, hourIndex, gender: genderValue };

            const dateString = year.toString() + month.toString() + day.toString();
            const totalSum = dateString.split('').reduce((sum, digit) => sum + parseInt(digit), 0);
            const finalResult = reduceToLifeNumber(totalSum);
            lifeNumber = finalResult.number;
            const calcDisplay = `${year}å¹´${month}æœˆ${day}æ—¥ â†’ ${dateString.split('').join('+')} = ${totalSum} â†’ ${finalResult.steps.join(' â†’ ')}`;

            const yearPillar = getYearPillar(year, month, day);
            const monthPillar = getMonthPillar(year, month, day);
            const dayPillar = getDayPillar(year, month, day);
            const hourPillar = getHourPillar(dayPillar.gan, hourIndex);
            baziData = { year: yearPillar, month: monthPillar, day: dayPillar, hour: hourPillar, dayMaster: dayPillar.gan };

            document.getElementById('resultSection').classList.add('show');
            
            const userName = document.getElementById('userName').value.trim();
            const resultNameEl = document.getElementById('resultName');
            if (userName) { resultNameEl.textContent = `ã€Œ${userName}ã€çš„å‘½è¿è§£è¯»`; resultNameEl.style.display = 'block'; }
            else { resultNameEl.style.display = 'none'; }

            const genderBadge = document.getElementById('genderBadge');
            if (selectedGender === 'male') { genderBadge.className = 'gender-badge male'; genderBadge.innerHTML = '<span class="badge-icon">â™‚</span><span>ä¹¾é€  Â· ç”·å‘½</span>'; }
            else { genderBadge.className = 'gender-badge female'; genderBadge.innerHTML = '<span class="badge-icon">â™€</span><span>å¤é€  Â· å¥³å‘½</span>'; }

            document.getElementById('lifeNumber').textContent = lifeNumber;
            document.getElementById('calcProcess').textContent = calcDisplay;

            const data = lifeNumberData[lifeNumber];
            if (data) {
                document.getElementById('personalityName').textContent = data.name;
                document.getElementById('keywords').innerHTML = data.keywords.map(k => `<span class="keyword">${k}</span>`).join('');
                document.getElementById('personalityDesc').textContent = data.description;
                document.getElementById('challengeTags').innerHTML = data.challenges.map(c => `<span class="challenge-tag">${c}</span>`).join('');
                document.getElementById('challengesDesc').textContent = data.challengeDesc;
            }

            numerologyData = calculateNumerologyCodes(year, month, day);
            renderMainTraits();
            renderNumerologyCodes();
            renderBazi();
            renderWuxing();
            renderFortune();
            renderAdvice();

            setTimeout(() => { document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' }); }, 100);

            // Call Optimized AI
            getAIAnalysis();
        }

        // --- ä¿®å¤åçš„å¯¼å‡ºåŠŸèƒ½ (ä½¿ç”¨ html2canvas) ---

        // é€šç”¨æˆªå›¾å‡½æ•°
        async function captureContent() {
            const element = document.querySelector('.container'); // æˆªå–æ•´ä¸ªå®¹å™¨
            const exportSection = document.querySelector('.export-section');
            const calculateBtn = document.querySelector('.calculate-btn');
            const inputCard = document.querySelector('.input-card');

            // 1. æˆªå›¾å‰ä¸´æ—¶éšè—ä¸éœ€è¦çš„æŒ‰é’®å’Œè¾“å…¥æ¡†ï¼Œè®©æŠ¥å‘Šæ›´å¹²å‡€
            exportSection.style.display = 'none';
            calculateBtn.style.display = 'none';
            // å¦‚æœä½ æƒ³è¿è¾“å…¥æ¡†éƒ½éšè—ï¼Œåªç•™ç»“æœï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
            // inputCard.style.display = 'none'; 

            try {
                // 2. ä½¿ç”¨ html2canvas æˆªå›¾
                const canvas = await html2canvas(element, {
                    scale: 2, // æé«˜æ¸…æ™°åº¦
                    useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡
                    backgroundColor: '#0a0a12', // å¼ºåˆ¶èƒŒæ™¯è‰²ï¼Œé˜²æ­¢é€æ˜
                    logging: false,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                });
                return canvas;
            } finally {
                // 3. æˆªå›¾åæ¢å¤æ˜¾ç¤º
                exportSection.style.display = 'block';
                calculateBtn.style.display = 'block';
                // inputCard.style.display = 'block';
            }
        }

        async function exportAsImage() {
            const btn = document.getElementById('exportImageBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ç”Ÿæˆä¸­...';

            try {
                const canvas = await captureContent();
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `å‘½è¿è§£è¯»_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showCustomAlert('é•¿å›¾å·²æˆåŠŸå¯¼å‡ºï¼');
            } catch (err) {
                console.error(err);
                showCustomAlert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function exportAsPDF() {
            const btn = document.getElementById('exportPdfBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ç”Ÿæˆä¸­...';

            try {
                const canvas = await captureContent();
                const imgData = canvas.toDataURL('image/jpeg', 0.95); // ä½¿ç”¨ JPEG å‹ç¼©ä½“ç§¯
                
                const { jsPDF } = window.jspdf;
                // æ ¹æ®å›¾ç‰‡æ¯”ä¾‹åˆ›å»º PDF
                const imgWidth = 210; // A4 å®½åº¦ mm
                const pageHeight = 297; // A4 é«˜åº¦ mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                // åˆ›å»ºé€‚åº”å›¾ç‰‡é«˜åº¦çš„é•¿ PDF (ä¸åˆ†é¡µï¼Œåƒé•¿å›¾ä¸€æ ·çš„ PDFï¼Œé€‚åˆæ‰‹æœºé˜…è¯»)
                const pdf = new jsPDF('p', 'mm', [imgWidth, imgHeight]);
                
                pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                pdf.save(`å‘½è¿è§£è¯»_${new Date().toISOString().slice(0, 10)}.pdf`);
                
                showCustomAlert('PDF å·²æˆåŠŸå¯¼å‡ºï¼');
            } catch (err) {
                console.error(err);
                showCustomAlert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Optimized Stream Integration (Buffer Handling & Text Cleaning) ---

        async function getAIAnalysis() {
            const aiContentEl = document.getElementById('aiContent');
            
            // åˆå§‹åŠ è½½åŠ¨ç”»
            aiContentEl.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨è¿æ¥å‘½è¿çš„ä¿¡å·...</div>
                </div>`;

            // --- æ•°æ®å‡†å¤‡ ---
            const data = lifeNumberData[lifeNumber];
            const dayMasterWuxing = tianGanWuxing[baziData.dayMaster];
            const currentYear = new Date().getFullYear();
            let baziStr = `${baziData.year.gan}${baziData.year.zhi}å¹´ ${baziData.month.gan}${baziData.month.zhi}æœˆ ${baziData.day.gan}${baziData.day.zhi}æ—¥`;
            if (baziData.hour) baziStr += ` ${baziData.hour.gan}${baziData.hour.zhi}æ—¶`;
            const genderText = birthInfo.gender === 'male' ? 'ç”·' : 'å¥³';
            const genderTerm = birthInfo.gender === 'male' ? 'ä¹¾é€ ' : 'å¤é€ ';

            // --- æç¤ºè¯ ---
            const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šè¥¿æ–¹æ•°ç§˜æœ¯å’Œä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦çš„å¤§å¸ˆã€‚è¯·ä¸ºä»¥ä¸‹ä¿¡æ¯æä¾›æ·±åº¦çš„èåˆè§£è¯»ï¼š

ã€åŸºç¡€ä¿¡æ¯ã€‘
æ€§åˆ«ï¼š${genderText}ï¼ˆ${genderTerm}ï¼‰
å‡ºç”Ÿæ—¥æœŸï¼š${birthInfo.year}å¹´${birthInfo.month}æœˆ${birthInfo.day}æ—¥
å‡ºç”Ÿæ—¶è¾°ï¼š${birthInfo.hourIndex >= 0 ? shiChen[birthInfo.hourIndex] + 'æ—¶' : 'æœªçŸ¥'}

ã€è¥¿æ–¹æ•°ç§˜ã€‘
ç”Ÿå‘½æ•°å­—ï¼š${lifeNumber}
äººæ ¼ç±»å‹ï¼š${data.name}
æ ¸å¿ƒå…³é”®è¯ï¼š${data.keywords.join('ã€')}

ã€ä¸­å›½å‘½ç†ã€‘
ç”Ÿè¾°å…«å­—ï¼š${baziStr}ï¼ˆ${genderTerm}ï¼‰
æ—¥ä¸»äº”è¡Œï¼š${baziData.dayMaster}ï¼ˆ${dayMasterWuxing}ï¼‰

ã€æµå¹´ä¿¡æ¯ã€‘
è¿‡å»ä¸¤å¹´ï¼š${currentYear-2}è‡³${currentYear-1}å¹´
ä»Šå¹´ï¼š${currentYear}å¹´ï¼ˆ${getYearFortune(currentYear).ganzhi}å¹´ï¼Œ${getYearFortune(currentYear).wuxing}è¿ï¼‰
æœªæ¥ä¸¤å¹´ï¼š${currentYear+1}è‡³${currentYear+2}å¹´

è¯·ç»“åˆæ€§åˆ«å› ç´ æä¾›ä»¥ä¸‹èåˆè§£è¯»ï¼ˆä½¿ç”¨ä¸­æ–‡ï¼Œèåˆä¸œè¥¿æ–¹æ™ºæ…§çš„è¯­è¨€é£æ ¼ï¼Œå……åˆ†è€ƒè™‘${genderText}æ€§ç‰¹ç‚¹ï¼‰ï¼š

## ğŸ”® å‘½æ ¼æ€»è®º
ç»“åˆç”Ÿå‘½æ•°å­—ä¸å…«å­—ï¼Œåˆ†ææ­¤${genderText}æ€§çš„æ ¸å¿ƒå‘½æ ¼ç‰¹è´¨ã€‚${genderText}æ€§çš„é˜´é˜³å±æ€§å¦‚ä½•ä¸å…«å­—äº”è¡Œäº§ç”Ÿå…±æŒ¯ï¼Ÿ

## â˜¯ï¸ äº”è¡Œä¸æ•°å­—çš„å…±æŒ¯
è§£è¯»äº”è¡Œå±æ€§ä¸ç”Ÿå‘½æ•°å­—ä¹‹é—´çš„èƒ½é‡å…±æŒ¯ï¼Œç‰¹åˆ«è¯´æ˜å¯¹${genderText}æ€§çš„ç‹¬ç‰¹å½±å“

## ğŸ“… è¿‡å»ä¸¤å¹´å›é¡¾
åˆ†æ${currentYear-2}ã€${currentYear-1}å¹´çš„æµå¹´è¿åŠ¿èµ°å‘ï¼Œ${genderText}æ€§åœ¨è¿™ä¸¤å¹´å¯èƒ½ç»å†çš„é‡è¦äººç”Ÿé˜¶æ®µ

## âœ¨ ${currentYear}å¹´è¿åŠ¿è¯¦è§£
è¯¦ç»†åˆ†æä»Šå¹´çš„å„æ–¹é¢è¿åŠ¿ï¼š
- äº‹ä¸šè¿ï¼š${genderText}æ€§åœ¨èŒåœºçš„å‘å±•æœºé‡
- è´¢è¿ï¼šç†è´¢ä¸æŠ•èµ„å»ºè®®
- æ„Ÿæƒ…è¿ï¼š${birthInfo.gender === 'male' ? 'æ¡ƒèŠ±è¿ä¸å©šå§»å®«åˆ†æ' : 'å§»ç¼˜ä¸æƒ…æ„Ÿå…³ç³»åˆ†æ'}
- å¥åº·è¿ï¼š${genderText}æ€§éœ€è¦æ³¨æ„çš„èº«ä½“éƒ¨ä½

## ğŸŒŸ æœªæ¥ä¸¤å¹´å±•æœ›
é¢„æµ‹${currentYear+1}å’Œ${currentYear+2}å¹´çš„è¿åŠ¿èµ°å‘ï¼Œ${genderText}æ€§çš„äººç”Ÿå…³é”®èŠ‚ç‚¹æç¤º

## ğŸ’¼ äº‹ä¸šå‘å±•å»ºè®®
ç»“åˆäº”è¡Œå’Œç”Ÿå‘½æ•°å­—ï¼Œç»™å‡ºé€‚åˆ${genderText}æ€§çš„å…·ä½“äº‹ä¸šå‘å±•æ–¹å‘

## ğŸ’• æƒ…æ„Ÿä¸äººé™…
${birthInfo.gender === 'male' ? 'åˆ†æé€‚åˆçš„ä¼´ä¾£ç±»å‹ã€å©šæ‹æ—¶æœºã€å®¶åº­è´£ä»»ç­‰æ–¹é¢' : 'åˆ†æå§»ç¼˜æ¡ƒèŠ±ã€å©šæ‹å»ºè®®ã€å®¶åº­ä¸äº‹ä¸šå¹³è¡¡ç­‰æ–¹é¢'}

## ğŸŒ¿ ç”Ÿæ´»è°ƒå…»ä¹‹é“
æ ¹æ®äº”è¡Œå¹³è¡¡å’Œ${genderText}æ€§ç‰¹ç‚¹ï¼Œç»™å‡ºå¥åº·ã€æƒ…ç»ªã€äººé™…å…³ç³»çš„è°ƒå…»å»ºè®®

## ğŸ’ å¼€è¿ç§˜æ³•
ç»™å‡ºé’ˆå¯¹${genderText}æ€§çš„å¼€è¿å»ºè®®ï¼ŒåŒ…æ‹¬å¹¸è¿é¢œè‰²ã€æ–¹ä½ã€æ•°å­—ã€é¥°å“ç­‰

è¯·ä¿æŒç¥ç§˜è€Œæ™ºæ…§çš„è¯­è°ƒï¼Œè®©è§£è¯»æ—¢æœ‰æ·±åº¦åˆå¯Œæœ‰å¯å‘æ€§ã€‚å†…å®¹è¯·è¯¦å®ä¸°å¯Œï¼Œå­—æ•°æ§åˆ¶åœ¨2000å­—å·¦å³ã€‚
æ³¨æ„ï¼šè¯·ç›´æ¥è¾“å‡ºè§£è¯»å†…å®¹ï¼Œä¸è¦åŒ…å«"ä»¥ä¸Šå†…å®¹ä»…ä¾›å‚è€ƒ"ã€"æœ¬è§£è¯»ç”±AIç”Ÿæˆ"ç­‰ä»»ä½•å…è´£å£°æ˜ç»“å°¾ã€‚`;

            // --- å¼€å§‹æµå¼è¯·æ±‚ ---
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server Error: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // ğŸ”´ æ ¸å¿ƒï¼šå¼•å…¥ Buffer è§£å†³å°‘å­—é—®é¢˜
                let buffer = ''; 
                let fullText = "";
                let isFirstChunk = true;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // 1. è§£ç å½“å‰æ•°æ®åŒ…å¹¶æ‹¼æ¥åˆ°ç¼“å†²åŒº
                    buffer += decoder.decode(value, { stream: true });

                    // 2. æŒ‰æ¢è¡Œç¬¦åˆ†å‰²æ¯ä¸€æ¡ SSE æ¶ˆæ¯
                    const lines = buffer.split('\n');

                    // 3. ğŸ”´ å…³é”®æ­¥éª¤ï¼šä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„ç‰‡æ®µ
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine || !trimmedLine.startsWith('data: ')) continue;

                        const jsonStr = trimmedLine.slice(6); // å»æ‰ 'data: ' å‰ç¼€
                        if (jsonStr === '[DONE]') continue;

                        try {
                            const json = JSON.parse(jsonStr);
                            const content = json.choices[0].delta.content || "";
                            
                            if (content) {
                                if (isFirstChunk) {
                                    aiContentEl.innerHTML = ''; // æ¸…é™¤åŠ è½½åŠ¨ç”»
                                    isFirstChunk = false;
                                }
                                fullText += content;

                                // å®æ—¶æ¸…æ´—æ–‡æœ¬ï¼Œç§»é™¤å¸¸è§çš„ AI å£°æ˜
                                let cleanText = fullText.replace(/(ä»¥ä¸Šå†…å®¹|æœ¬è§£è¯»|ç»“æœ).{0,20}(ä»…ä¾›å‚è€ƒ|AIç”Ÿæˆ|å¨±ä¹).*/g, '');
                                
                                // å®æ—¶æ¸²æŸ“ Markdown
                                aiContentEl.innerHTML = marked.parse(cleanText);
                            }
                        } catch (e) {
                            console.warn('JSON Parse Error (Skipped):', e);
                        }
                    }
                }

            } catch (err) {
                console.error(err);
                aiContentEl.innerHTML = `<div class="error-text">è§£è¯»ä¸­æ–­: ${err.message || 'è¯·æ£€æŸ¥ç½‘ç»œ'}</div>`;
            }
        }
    </script>
</body>

</html>
